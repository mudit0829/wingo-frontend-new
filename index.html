<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WinGo Game</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

 <div class="header">
  <img src="assets/logo.png" alt="Game Logo" class="logo">
  <div class="header-icons">
    <img src="assets/user-icon.png" alt="User" class="icon">
    <img src="assets/settings-icon.png" alt="Settings" class="icon">
  </div>
</div>

<div class="wallet-card">
  <div class="wallet-balance">
    <div class="balance-amount">â‚¹<span id="walletAmount">7.66</span></div>
    <div class="balance-label">Wallet balance</div>
  </div>
  <div class="wallet-buttons">
    <button class="btn-withdraw">Withdraw</button>
    <button class="btn-deposit">Deposit</button>
  </div>
</div>

<div class="footer-message">
  <span class="speaker-icon">ðŸ”Š</span>
  Please Fill In The Correct Bank Card Inform
  <button class="detail-btn">Detail</button>
</div>

  <!-- Round Selection Tabs -->
<div class="round-tabs">
  <div class="tab active">
    <img src="assets/clock-active.png" alt="WinGo 30s">
    <span>WinGo 30sec</span>
  </div>
  <div class="tab">
    <img src="assets/clock-inactive.png" alt="WinGo 1min">
    <span>WinGo 1 Min</span>
  </div>
  <div class="tab">
    <img src="assets/clock-inactive.png" alt="WinGo 3min">
    <span>WinGo 3 Min</span>
  </div>
  <div class="tab">
    <img src="assets/clock-inactive.png" alt="WinGo 5min">
    <span>WinGo 5 Min</span>
  </div>
</div>

<!-- Timer & Round Info Card -->
<div class="timer-section">
  <div class="how-to-play">
    <!-- No icon, just text for now -->
    <button class="how-to-play-btn">How to play</button>
    <div class="game-type">WinGo 30sec</div>
  </div>
  <div class="timer-info">
    <div class="timer-balls">
      <img src="assets/ball-2.png" alt="2">
      <img src="assets/ball-3.png" alt="3">
      <img src="assets/ball-5.png" alt="5">
      <img src="assets/ball-9.png" alt="9">
      <img src="assets/ball-5.png" alt="5">
    </div>
    <div class="timer-countdown">
      <div class="time-label">Time remaining</div>
      <div class="time-digits" id="timeDigits">00:14</div>
      <div class="round-id" id="roundId">20250806100050834</div>
    </div>
  </div>
</div>

  <!-- Phase 3: Color Betting Section -->
<div class="color-betting-section">
  <button class="color-btn green" onclick="selectColor('Green')">
    <span>Green</span>
  </button>
  <button class="color-btn violet" onclick="selectColor('Violet')">
    <span>Violet</span>
  </button>
  <button class="color-btn red" onclick="selectColor('Red')">
    <span>Red</span>
  </button>
</div>

<!-- Number Balls Grid -->
<div class="number-balls-grid">
  <img src="assets/ball-0.png" alt="0" class="number-ball" onclick="selectNumber(0)">
  <img src="assets/ball-1.png" alt="1" class="number-ball" onclick="selectNumber(1)">
  <img src="assets/ball-2.png" alt="2" class="number-ball" onclick="selectNumber(2)">
  <img src="assets/ball-3.png" alt="3" class="number-ball" onclick="selectNumber(3)">
  <img src="assets/ball-4.png" alt="4" class="number-ball" onclick="selectNumber(4)">
  <img src="assets/ball-5.png" alt="5" class="number-ball" onclick="selectNumber(5)">
  <img src="assets/ball-6.png" alt="6" class="number-ball" onclick="selectNumber(6)">
  <img src="assets/ball-7.png" alt="7" class="number-ball" onclick="selectNumber(7)">
  <img src="assets/ball-8.png" alt="8" class="number-ball" onclick="selectNumber(8)">
  <img src="assets/ball-9.png" alt="9" class="number-ball" onclick="selectNumber(9)">
</div>

<!-- Multipliers Row -->
<div class="multipliers-row">
  <button class="multiplier-btn random" onclick="selectMultiplier('Random')">Random</button>
  <button class="multiplier-btn active" onclick="selectMultiplier('X1')">X1</button>
  <button class="multiplier-btn" onclick="selectMultiplier('X5')">X5</button>
  <button class="multiplier-btn" onclick="selectMultiplier('X10')">X10</button>
  <button class="multiplier-btn" onclick="selectMultiplier('X20')">X20</button>
  <button class="multiplier-btn" onclick="selectMultiplier('X50')">X50</button>
  <button class="multiplier-btn" onclick="selectMultiplier('X100')">X100</button>
</div>
  <!-- Phase 4: History Tabs -->
<div class="history-tabs">
<button class="tab-btn active" onclick="showTab('gameHistory', this)">Game history</button>
<button class="tab-btn" onclick="showTab('chart', this)">Chart</button>
<button class="tab-btn" onclick="showTab('myHistory', this)">My history</button>
</div>

<!-- Game History Section -->
<div class="tab-content" id="gameHistory">
  <table class="history-table">
    <tr><th>Period</th><th>Number</th><th>Big Small</th><th>Color</th></tr>
    <tr><td>20250806100051046</td><td>2</td><td>Small</td><td><span class="dot red"></span></td></tr>
    <tr><td>20250806100051045</td><td>3</td><td>Small</td><td><span class="dot green"></span></td></tr>
    <tr><td>20250806100051044</td><td>6</td><td>Big</td><td><span class="dot red"></span></td></tr>
    <tr><td>20250806100051043</td><td>8</td><td>Big</td><td><span class="dot red"></span></td></tr>
    <tr><td>20250806100051042</td><td>0</td><td>Small</td><td><span class="dot red"></span> <span class="dot violet"></span></td></tr>
    <tr><td>20250806100051041</td><td>9</td><td>Big</td><td><span class="dot green"></span></td></tr>
  </table>
</div>

<!-- Chart Section -->
<div class="tab-content hidden" id="chart">
  <table class="history-table">
    <tr><th>Statistic</th><th colspan="10">(last 100 Periods)</th></tr>
    <tr><td>Winning Numbers</td><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td></tr>
    <tr><td>Missing</td><td>0</td><td>25</td><td>2</td><td>3</td><td>10</td><td>15</td><td>4</td><td>1</td><td>5</td><td>7</td></tr>
    <tr><td>Avg missing</td><td>8</td><td>11</td><td>6</td><td>32</td><td>7</td><td>10</td><td>6</td><td>7</td><td>13</td><td>6</td></tr>
    <tr><td>Frequency</td><td>10</td><td>7</td><td>13</td><td>12</td><td>11</td><td>12</td><td>13</td><td>12</td><td>13</td><td>12</td></tr>
    <tr><td>Max consecutive</td><td>1</td><td>2</td><td>2</td><td>1</td><td>2</td><td>1</td><td>2</td><td>1</td><td>2</td><td>2</td></tr>
  </table>
  <div class="chart-trend">
    <!-- Simplified visual lines -->
    <div>20250806100051048: 0 (S)</div>
    <div>20250806100051047: 7 (B)</div>
    <div>20250806100051046: 2 (S)</div>
    <div>20250806100051045: 3 (S)</div>
  </div>
</div>

<!-- My History Section -->
<div class="tab-content hidden" id="myHistory">
  <div class="my-history-item succeed">
    <div class="color-box green"></div>
    <div>
      <div>20250806100051054</div>
      <div>2025-08-06 14:16:51</div>
    </div>
    <div class="status succeed">Succeed</div>
    <div class="amount">+â‚¹1.96</div>
  </div>
  <div class="my-history-item failed">
    <div class="color-box green"></div>
    <div>
      <div>20250806100051053</div>
      <div>2025-08-06 14:16:09</div>
    </div>
    <div class="status failed">Failed</div>
    <div class="amount">-â‚¹1.00</div>
  </div>
  <!-- Add more history items similarly -->
</div>

  <!-- Betting Popup -->
<div id="betPopup" class="bet-popup">
  <div class="popup-content" id="popupContent">
    <span class="close-btn" onclick="closeBetPopup()">&times;</span>
    <h2 id="betTitle">Place Your Bet</h2>
    <p>You selected: <span id="selectedBetValue"></span></p>
    <input type="number" id="betAmount" placeholder="Enter amount" min="1" />
    <button onclick="confirmBet()">Confirm Bet</button>
  </div>
</div>

  

<script>
  // Keep your original tab behavior
  function showTab(tabId, btnEl) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    const target = document.getElementById(tabId);
    if (target) target.classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (btnEl) btnEl.classList.add('active');
  }

  // Run when page ready
  document.addEventListener('DOMContentLoaded', () => {
    initPhase4();
  });

  const apiUrl = "https://wingo-backend-nqk5.onrender.com";
  const currentEmail = localStorage.getItem("userEmail") || "user@example.com";
  let currentRoundId = "";

  // -------- Init & helpers --------
  async function initPhase4() {
    await safeCall(fetchWalletBalance, 'fetchWalletBalance');
    await safeCall(fetchCurrentRound, 'fetchCurrentRound');
    await safeCall(loadGameHistory, 'loadGameHistory');
    await safeCall(loadMyHistory, 'loadMyHistory');

    // keep round updated
    setInterval(() => safeCall(fetchCurrentRound, 'fetchCurrentRound'), 1000);
  }

  async function safeCall(fn, name) {
    try { await fn(); } catch (err) { console.error(`${name} failed:`, err); }
  }

  // -------- Wallet & Round (unchanged behavior) --------
  async function fetchWalletBalance() {
    try {
      const res = await fetch(`${apiUrl}/api/users/wallet/${encodeURIComponent(currentEmail)}`);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const data = await res.json();
      const balance = (typeof data.wallet !== 'undefined') ? data.wallet : (data.balance ?? 0);
      const el = document.getElementById("walletAmount");
      if (el) el.innerText = parseFloat(balance || 0).toFixed(2);
    } catch (err) {
      console.error("Wallet Fetch Failed:", err);
    }
  }

  async function fetchCurrentRound() {
    try {
      const res = await fetch(`${apiUrl}/api/rounds`);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      const rounds = await res.json();
      if (!Array.isArray(rounds) || rounds.length === 0) return;
      const round = rounds[0];
      currentRoundId = round.roundId || currentRoundId;
      const roundEl = document.getElementById("roundId");
      if (roundEl && round.roundId) roundEl.innerText = round.roundId;

      // Timer display (safe)
      if (round.startTime) {
        const startTime = new Date(round.startTime).getTime();
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const remaining = 30 - elapsed;
        const timeEl = document.getElementById("timeDigits");
        if (timeEl) {
          if (remaining <= 0) timeEl.innerText = "00:00";
          else {
            const m = String(Math.floor(remaining / 60)).padStart(2, '0');
            const s = String(remaining % 60).padStart(2, '0');
            timeEl.innerText = `${m}:${s}`;
          }
        }
      }
    } catch (err) {
      console.error("Round Fetch Failed:", err);
    }
  }

  // -------- Game History (keeps color mapping) --------
  async function loadGameHistory() {
    const container = document.getElementById('gameHistory');
    if (!container) return;
    try {
      const res = await fetch(`${apiUrl}/api/rounds`);
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      let rounds = await res.json();

      // remove duplicate roundId entries (keep first occurrence)
      const seen = new Set();
      rounds = rounds.filter(r => {
        if (!r || !r.roundId) return false;
        if (seen.has(r.roundId)) return false;
        seen.add(r.roundId);
        return true;
      });

      renderGameHistory(container, rounds);
    } catch (err) {
      console.error("Failed to load Game History:", err);
      container.innerHTML = `<div style="padding:12px;color:#ffb3b3">Unable to load game history: ${err.message}</div>`;
    }
  }

  function renderGameHistory(container, rounds) {
    // create or reuse table with header
    let table = container.querySelector('.history-table');
    if (!table) {
      table = document.createElement('table');
      table.className = 'history-table';
      table.innerHTML = `<tr><th>Period</th><th>Number</th><th>Big Small</th><th>Color</th></tr>`;
      container.innerHTML = '';
      container.appendChild(table);
    } else {
      // clear old rows (keep header)
      table.querySelectorAll('tr:not(:first-child)').forEach(r => r.remove());
    }

    // append up to 20 rounds
    const fragment = document.createDocumentFragment();
    rounds.slice(0, 20).forEach(r => {
      const row = document.createElement('tr');

      const number = (typeof r.resultNumber !== 'undefined' && r.resultNumber !== null) ? r.resultNumber : '-';
      const color = (r.resultColor || '').toLowerCase();
      const colorDot = color ? `<span class="dot ${color}"></span>` : '-';

      row.innerHTML = `
        <td>${r.roundId ?? '-'}</td>
        <td>${number}</td>
        <td>-</td>
        <td>${colorDot}</td>
      `;
      fragment.appendChild(row);
    });

    table.appendChild(fragment);
  }

  // -------- My History (group bets by round and show number & color together) --------
  async function loadMyHistory() {
    const container = document.getElementById('myHistory');
    if (!container) return;
    try {
      const [betsRes, roundsRes] = await Promise.all([
        fetch(`${apiUrl}/api/bets/user/${encodeURIComponent(currentEmail)}`),
        fetch(`${apiUrl}/api/rounds`)
      ]);
      if (!betsRes.ok) throw new Error(`Bets: ${betsRes.status} ${betsRes.statusText}`);
      if (!roundsRes.ok) throw new Error(`Rounds: ${roundsRes.status} ${roundsRes.statusText}`);

      const bets = await betsRes.json();
      const rounds = await roundsRes.json();
      const roundMap = new Map((rounds || []).map(r => [r.roundId, r]));

      renderMyHistory(container, bets || [], roundMap);
    } catch (err) {
      console.error("Failed to load My History:", err);
      container.innerHTML = `<div style="padding:12px;color:#ffb3b3">Unable to load your history: ${err.message}</div>`;
    }
  }

  // calculate displayable return amount for a bet
  function computeBetReturnAmount(bet) {
    // Prefer explicit payout / return fields if provided
    if (typeof bet.payout === 'number') return Number(bet.payout);
    if (typeof bet.payout === 'string' && bet.payout !== '') {
      const p = Number(bet.payout);
      if (!isNaN(p)) return p;
    }
    if (typeof bet.returnAmount === 'number') return Number(bet.returnAmount);
    if (typeof bet.winAmount === 'number') return Number(bet.amount || 0) + Number(bet.winAmount);
    // netAmount might represent profit (so add to stake), or might be total â€” try to handle both:
    if (typeof bet.netAmount === 'number') {
      // assume netAmount is profit; show stake + profit
      return Number(bet.amount || 0) + Number(bet.netAmount);
    }
    // fallback: if win show stake back, otherwise 0 (we will represent loss separately)
    if (bet.win === true) return Number(bet.amount || 0);
    return -Number(bet.amount || 0);
  }

  function formatCurrency(val) {
    const n = Number(val || 0);
    const sign = n >= 0 ? '+' : '-';
    return `${sign}â‚¹${Math.abs(n).toFixed(2)}`;
  }

  function renderMyHistory(container, bets, roundMap) {
    container.innerHTML = '';

    if (!Array.isArray(bets) || bets.length === 0) {
      container.innerHTML = `<div style="padding:12px;color:#ccc">No bets found.</div>`;
      return;
    }

    // Group bets by roundId
    const groups = new Map();
    bets.forEach(b => {
      const key = b.roundId ?? ('unknown-' + (b._id || Math.random()));
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(b);
    });

    // Convert groups to array and sort by latest timestamp desc
    const groupsArr = Array.from(groups.entries()).map(([roundId, arr]) => {
      // determine latest timestamp for this group's ordering
      const times = arr.map(x => new Date(x.timestamp || x.createdAt || 0).getTime() || 0);
      const latest = Math.max(...times);
      return { roundId, bets: arr, latest };
    }).sort((a,b) => b.latest - a.latest);

    // render up to 20 groups
    groupsArr.slice(0, 20).forEach(group => {
      const groupBets = group.bets;

      // prefer numberBet (if any) and prefer colorBet (if any)
      const numberBetObj = groupBets.find(x => typeof x.numberBet !== 'undefined' && x.numberBet !== null);
      const colorBetObj = groupBets.find(x => typeof x.colorBet !== 'undefined' && x.colorBet !== null);

      // fallback to round result color if no colorBet
      const roundInfo = roundMap.get(group.roundId) || {};
      const roundColor = (roundInfo.resultColor || '').toString().toLowerCase();
      const colorClass = (colorBetObj?.colorBet || roundColor || '').toString().toLowerCase() || 'green';
      const numberValue = numberBetObj ? String(numberBetObj.numberBet ?? numberBetObj.number ?? numberBetObj.number_choice ?? numberBetObj.numberBet) : null;

      // compute aggregate amount for group (sum per-bet return: wins positive, losses negative)
      let aggregate = 0;
      let anyWin = false;
      groupBets.forEach(b => {
        const val = computeBetReturnAmount(b);
        // computeBetReturnAmount returns negative for losses; for wins it returns positive total returned
        // But if compute returned negative value (fallback), keep it negative.
        if (b.win === true) anyWin = true;
        aggregate += Number(val || 0);
      });

      // However aggregate currently is "sum of displayed returns". For consistent display when losses,
      // we want to show -stake for losing bet. For wins, show total returned (stake + profit).
      // To keep display consistent with user expectations, we leave aggregate as computed.
      const amountText = (aggregate >= 0) ? `+â‚¹${aggregate.toFixed(2)}` : `-â‚¹${Math.abs(aggregate).toFixed(2)}`;

      // latest timestamp to show
      const latestTs = group.latest || 0;
      const timeText = latestTs ? new Date(latestTs).toLocaleString() : '-';

      // compose the element
      const wrapper = document.createElement('div');
      wrapper.className = `my-history-item ${anyWin ? 'succeed' : 'failed'}`;

      // left column: number badge above color-box (if present)
      const leftHtmlParts = [];
      if (numberValue !== null && numberValue !== undefined) {
        leftHtmlParts.push(`<div style="display:flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:#6b5bff;color:#fff;font-weight:bold;margin-bottom:6px">${numberValue}</div>`);
      }
      leftHtmlParts.push(`<div class="color-box ${colorClass}"></div>`);

      wrapper.innerHTML = `
        <div style="display:flex;flex-direction:row;gap:12px;align-items:center;width:60%">
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center">
            ${leftHtmlParts.join('')}
          </div>
          <div style="flex:1;text-align:left">
            <div style="font-weight:bold">${group.roundId ?? '-'}</div>
            <div style="font-size:12px;opacity:0.8">${timeText}</div>
          </div>
        </div>

        <div style="width:80px;text-align:center">
          <div class="status ${anyWin ? 'succeed' : 'failed'}">${anyWin ? 'Succeed' : 'Failed'}</div>
        </div>

        <div style="width:100px;text-align:right">
          <div class="amount" style="color:${aggregate >= 0 ? '#4CAF50' : '#FF5252'};font-weight:bold">${amountText}</div>
        </div>
      `;

      container.appendChild(wrapper);
    });
  }

  // Expose small helper for debugging if needed:
  window._phase4_reload = function () {
    safeCall(loadGameHistory, 'loadGameHistory');
    safeCall(loadMyHistory, 'loadMyHistory');
    safeCall(fetchWalletBalance, 'fetchWalletBalance');
  };
</script>

</body>
</html>
